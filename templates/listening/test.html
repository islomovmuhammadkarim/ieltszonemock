<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IELTS Listening ‚Äî Alfa Mock</title>
  <style>
    :root {
      --ios-blue: #007AFF;
      --ios-red: #FF3B30;
      --glass: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.12);
      --input-bg: rgba(0, 0, 0, 0.3);
    }
    body {
      background: #0f1219;
      background-image: radial-gradient(at 0% 0%, rgba(0, 122, 255, 0.15) 0px, transparent 45%), radial-gradient(at 100% 100%, rgba(138, 43, 226, 0.15) 0px, transparent 45%);
      color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0; min-height: 100vh;
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .ios-card {
      background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; margin-bottom: 20px;
    }
    header { display: flex; justify-content: space-between; align-items: center; position: sticky; top: 10px; z-index: 1000; }
    .stat-pill { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 8px 15px; border-radius: 12px; }
    .time-left { color: var(--ios-red); font-weight: 800; font-size: 1.2rem; }
    .ios-input {
      width: 100%; box-sizing: border-box; background: var(--input-bg); border: 2px solid var(--glass-border);
      padding: 12px 15px; border-radius: 12px; color: #fff; font-size: 16px; transition: 0.3s; outline: none; margin-top: 8px;
    }
    .ios-input:focus { border-color: var(--ios-blue); }
    .opt-label {
      display: flex; align-items: center; gap: 12px; padding: 14px;
      background: rgba(255, 255, 255, 0.03); border: 1px solid var(--glass-border);
      border-radius: 14px; margin-bottom: 10px; cursor: pointer; transition: 0.2s;
    }
    .opt-label.active { background: rgba(0, 122, 255, 0.15); border-color: var(--ios-blue); }
    .btn { padding: 12px 25px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; text-decoration: none; display: inline-block; }
    .btn-blue { background: var(--ios-blue); color: #fff; }
    .btn-red { background: var(--ios-red); color: #fff; }
    .btn-glass { background: var(--glass); color: #fff; border: 1px solid var(--glass-border); }
    .start-overlay { position: fixed; inset: 0; z-index: 2000; background: rgba(10, 12, 18, 0.98); backdrop-filter: blur(40px); display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

<main class="container">

  <div class="start-overlay" id="startOverlay">
    <div class="ios-card" style="max-width: 450px; text-align: center;">
      <h1 style="margin-top:0">üéß Listening Test</h1>
      <p style="opacity: 0.7">Naushniklarni tekshiring va tayyor bo'lsangiz boshlang.</p>
      
      <audio id="checkAudio" controls style="width:100%; margin: 20px 0;">
        <source src="{{ test.audio.url }}" type="audio/mpeg">
      </audio>

      <button id="btnStart" class="btn btn-blue" style="width:100%">Testni Boshlash</button>
    </div>
  </div>

  <div id="listeningContent" style="display:none">
    
    <header style="margin-bottom: 20px;">
      <div style="display:flex; gap:10px">
        <div class="stat-pill">
          <span style="font-size:10px; display:block; opacity:0.6">TIME</span>
          <span id="timerText" class="time-left">30:00</span>
        </div>
        <div class="stat-pill">
          <span style="font-size:10px; display:block; opacity:0.6">PART</span>
          <span style="font-weight:700"><span id="partLabel">1</span> / {{ groups|length }}</span>
        </div>
      </div>
      <button id="btnFinish" class="btn btn-red">Finish Test</button>
    </header>

    <audio id="mainAudio" preload="auto">
      <source src="{{ test.audio.url }}" type="audio/mpeg">
    </audio>

    {% for group in groups %}
    <section class="listening-part" data-step="{{ forloop.counter }}" style="display: none;">
      <div class="ios-card" style="border-left: 4px solid var(--ios-blue);">
        <h2 style="margin:0 0 5px 0">{{ group.title }}</h2>
        <p style="margin:0; opacity:0.6; font-size:14px">{{ group.instructions }}</p>
      </div>

      {% if group.image %}
      <div class="ios-card" style="text-align: center; background: white; padding: 10px;">
        <img src="{{ group.image.url }}" style="max-width: 100%; border-radius: 10px;">
      </div>
      {% endif %}

      <div class="questions-grid">
        {% for q in group.questions.all %}
        <div class="ios-card question-box">
          <p style="margin:0; font-weight: 600;">{{ q.order }}. {{ q.prompt }}</p>
          
          <div class="options-container" data-qid="{{ q.id }}" data-qtype="{{ q.qtype }}">
            
            {% if q.qtype == "short" %}
              <input type="text" class="ios-input" placeholder="Your answer..." oninput="handleInputSave(this)">
            
            {% elif q.qtype == "map_labeling" %}
              <select class="ios-input" style="appearance: auto;" onchange="handleOptionSave(this)">
                <option value="">Select letter...</option>
                <option value="A">A</option><option value="B">B</option>
                <option value="C">C</option><option value="D">D</option>
                <option value="E">E</option><option value="F">F</option>
              </select>

            {% elif q.qtype == "mcq_single" or q.qtype == "mcq_multi" %}
              <div style="margin-top:10px">
                {% for opt in q.options.all %}
                <label class="opt-label">
                  <input type="{% if q.qtype == 'mcq_multi' %}checkbox{% else %}radio{% endif %}" 
                         name="q{{ q.id }}" value="{{ opt.key }}" 
                         class="answer-input" onchange="handleOptionSave(this)">
                  <span><b>{{ opt.key }}.</b> {{ opt.text }}</span>
                </label>
                {% endfor %}
              </div>

            {% else %}
              <input type="text" class="ios-input" placeholder="Answer..." oninput="handleInputSave(this)">
            {% endif %}

          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endfor %}

    <div style="display: flex; justify-content: space-between; margin-top: 20px; padding-bottom: 50px;">
      <button class="btn btn-glass" id="btnPrev">‚¨ÖÔ∏è Back</button>
      <button class="btn btn-blue" id="btnNext">Next ‚û°Ô∏è</button>
    </div>

  </div>
</main>

<script>
(function(){
  const TOTAL = 30 * 60;
  const overlay = document.getElementById("startOverlay");
  const btnStart = document.getElementById("btnStart");
  const content = document.getElementById("listeningContent");
  const timerText = document.getElementById("timerText");
  const checkAudio = document.getElementById("checkAudio");
  const audio = document.getElementById("mainAudio");
  const parts = Array.from(document.querySelectorAll(".listening-part"));
  const partLabel = document.getElementById("partLabel");
  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const btnFinish = document.getElementById("btnFinish");

  let time = TOTAL;
  let interval = null;
  let testStarted = false;
  let allowEnd = false;
  let step = 1;
  let lastGoodTime = 0;

  // Django Save Logic
  async function saveAnswer(qid, val) {
    const body = new URLSearchParams();
    body.append('question_id', qid);
    body.append('value', val);
    
    fetch("{% url 'listening_save_answer' %}", {
      method: 'POST',
      headers: { 
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: body
    });
  }

  window.handleInputSave = (el) => {
    const qid = el.closest('.options-container').dataset.qid;
    saveAnswer(qid, el.value);
  };

  window.handleOptionSave = (el) => {
    const container = el.closest('.options-container');
    const qid = container.dataset.qid;
    const type = container.dataset.qtype;
    
    // UI Active class
    if(type !== 'mcq_multi' && el.tagName !== 'SELECT') {
      container.querySelectorAll('.opt-label').forEach(l => l.classList.remove('active'));
    }
    if(el.checked) el.closest('.opt-label').classList.add('active');

    // Collect value
    let val = el.value;
    if(type === 'mcq_multi') {
      val = Array.from(container.querySelectorAll('input:checked')).map(i => i.value).join(',');
    }
    saveAnswer(qid, val);
  };

  function renderParts(){
    parts.forEach((p, i) => p.style.display = (i + 1 === step) ? "block" : "none");
    partLabel.textContent = step;
    btnPrev.style.visibility = (step === 1) ? "hidden" : "visible";
    btnNext.textContent = (step === parts.length) ? "Finish ‚úÖ" : "Next ‚û°Ô∏è";
  }

  btnStart.onclick = () => {
    checkAudio.pause();
    overlay.style.display = "none";
    content.style.display = "block";
    testStarted = true;
    audio.play();
    renderParts();
    interval = setInterval(() => {
      time--;
      timerText.textContent = Math.floor(time/60).toString().padStart(2,'0') + ":" + (time%60).toString().padStart(2,'0');
      if(time <= 0) finishTest();
    }, 1000);
  };

  btnNext.onclick = () => { 
    if(step < parts.length){ step++; renderParts(); window.scrollTo(0,0); }
    else finishTest();
  };
  btnPrev.onclick = () => { if(step > 1){ step--; renderParts(); window.scrollTo(0,0); }};

  async function finishTest() {
    if(allowEnd) return;
    if(!confirm("Testni yakunlaysizmi?")) return;
    allowEnd = true;
    audio.pause();
    const res = await fetch("{% url 'listening_submit' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    });
    const data = await res.json();
    window.location.href = data.redirect;
  }
  btnFinish.onclick = finishTest;

  // Audio security
  audio.ontimeupdate = () => { if(!audio.seeking) lastGoodTime = audio.currentTime; };
  audio.onseeking = () => { if(Math.abs(audio.currentTime - lastGoodTime) > 1.5) audio.currentTime = lastGoodTime; };
  audio.onpause = () => { if(!allowEnd && testStarted) audio.play(); };

})();
</script>
</body>
</html>