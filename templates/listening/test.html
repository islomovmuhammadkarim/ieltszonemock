{% extends "layouts/master.html" %}
{% load static %}

{% block title %}IELTS Listening ‚Äî {{ test.title|default:"Mock" }}{% endblock %}

{% block content %}
<div class="container container-narrow listening-page" style="padding-top: 50px;">

  <!-- START OVERLAY -->
  <div class="start-overlay" id="startOverlay" aria-modal="true" role="dialog">
    <div class="start-card">
      <h1 class="start-title">üéß Listening Test</h1>
      <p class="start-sub">Naushniklarni tekshiring va tayyor bo'lsangiz boshlang.</p>

      <audio id="checkAudio" controls class="audio-full">
        <source src="{{ test.audio.url }}" type="audio/mpeg">
      </audio>

      <button id="btnStart" class="btn btn-primary btn-full">Testni Boshlash</button>
    </div>
  </div>

  <!-- CONTENT -->
  <div id="listeningContent" class="listening-content" style="display:none">

    <header class="listening-topbar">
      <div class="topbar-left">
        <div class="stat-pill">
          <span class="stat-mini">TIME</span>
          <span id="timerText" class="time-left">30:00</span>
        </div>

        <div class="stat-pill">
          <span class="stat-mini">PART</span>
          <span class="stat-strong"><span id="partLabel">1</span> / {{ groups|length }}</span>
        </div>
      </div>

      <button id="btnFinish" class="btn btn-danger">Finish Test</button>
    </header>

    <audio id="mainAudio" preload="auto">
      <source src="{{ test.audio.url }}" type="audio/mpeg">
    </audio>

    {% for group in groups %}
      <section class="listening-part" data-step="{{ forloop.counter }}" style="display:none;">

        <div class="group-card">
          <div class="group-line"></div>
          <div class="group-body">
            <h2 class="group-title">{{ group.title }}</h2>
            <p class="group-sub">{{ group.instructions }}</p>
          </div>
        </div>

        {% if group.image %}
          <div class="img-card">
            <img src="{{ group.image.url }}" alt="Listening image" class="group-img">
          </div>
        {% endif %}

        <div class="questions-grid">
          {% for q in group.questions.all %}
            <div class="q-card">
              <p class="q-title">{{ q.order }}. {{ q.prompt }}</p>

              <div class="options-container" data-qid="{{ q.id }}" data-qtype="{{ q.qtype }}">
                {% if q.qtype == "short" %}
                  <input type="text" class="ui-input" placeholder="Your answer..." oninput="handleInputSave(this)">

                {% elif q.qtype == "map_labeling" %}
                  <select class="ui-input ui-select" onchange="handleOptionSave(this)">
                    <option value="">Select letter...</option>
                    <option value="A">A</option><option value="B">B</option>
                    <option value="C">C</option><option value="D">D</option>
                    <option value="E">E</option><option value="F">F</option>
                  </select>

                {% elif q.qtype == "mcq_single" or q.qtype == "mcq_multi" %}
                  <div class="options-list">
                    {% for opt in q.options.all %}
                      <label class="opt-item">
                        <input
                          type="{% if q.qtype == 'mcq_multi' %}checkbox{% else %}radio{% endif %}"
                          name="q{{ q.id }}"
                          value="{{ opt.key }}"
                          class="answer-input"
                          onchange="handleOptionSave(this)">
                        <span class="opt-text"><b>{{ opt.key }}.</b> {{ opt.text }}</span>
                      </label>
                    {% endfor %}
                  </div>

                {% else %}
                  <input type="text" class="ui-input" placeholder="Answer..." oninput="handleInputSave(this)">
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>

      </section>
    {% endfor %}

    <div class="nav-row">
      <button class="btn btn-ghost" id="btnPrev">‚¨ÖÔ∏è Back</button>
      <button class="btn btn-primary" id="btnNext">Next ‚û°Ô∏è</button>
    </div>

  </div>
</div>

<script>
(function(){
  const TOTAL = 30 * 60;

  const overlay = document.getElementById("startOverlay");
  const btnStart = document.getElementById("btnStart");
  const content = document.getElementById("listeningContent");
  const timerText = document.getElementById("timerText");
  const checkAudio = document.getElementById("checkAudio");
  const audio = document.getElementById("mainAudio");
  const parts = Array.from(document.querySelectorAll(".listening-part"));
  const partLabel = document.getElementById("partLabel");
  const btnPrev = document.getElementById("btnPrev");
  const btnNext = document.getElementById("btnNext");
  const btnFinish = document.getElementById("btnFinish");

  let time = TOTAL;
  let interval = null;
  let testStarted = false;
  let allowEnd = false;
  let step = 1;
  let lastGoodTime = 0;

  async function saveAnswer(qid, val) {
    const body = new URLSearchParams();
    body.append('question_id', qid);
    body.append('value', val);

    fetch("{% url 'listening_save_answer' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: body
    });
  }

  window.handleInputSave = (el) => {
    const qid = el.closest('.options-container').dataset.qid;
    saveAnswer(qid, el.value);
  };

  window.handleOptionSave = (el) => {
    const container = el.closest('.options-container');
    const qid = container.dataset.qid;
    const type = container.dataset.qtype;

    if(type !== 'mcq_multi' && el.tagName !== 'SELECT') {
      container.querySelectorAll('.opt-item').forEach(l => l.classList.remove('active'));
    }

    if(el.tagName !== 'SELECT' && el.checked) el.closest('.opt-item').classList.add('active');

    let val = el.value;
    if(type === 'mcq_multi') {
      val = Array.from(container.querySelectorAll('input:checked')).map(i => i.value).join(',');
    }
    saveAnswer(qid, val);
  };

  function renderParts(){
    parts.forEach((p, i) => p.style.display = (i + 1 === step) ? "block" : "none");
    partLabel.textContent = step;
    btnPrev.style.visibility = (step === 1) ? "hidden" : "visible";
    btnNext.textContent = (step === parts.length) ? "Finish ‚úÖ" : "Next ‚û°Ô∏è";
    window.scrollTo(0,0);
  }

  btnStart.onclick = () => {
    checkAudio.pause();
    overlay.style.display = "none";
    content.style.display = "block";
    testStarted = true;
    audio.play();
    renderParts();

    interval = setInterval(() => {
      time--;
      timerText.textContent =
        Math.floor(time/60).toString().padStart(2,'0') + ":" +
        (time%60).toString().padStart(2,'0');
      if(time <= 0) finishTest();
    }, 1000);
  };

  btnNext.onclick = () => {
    if(step < parts.length){ step++; renderParts(); }
    else finishTest();
  };
  btnPrev.onclick = () => { if(step > 1){ step--; renderParts(); } };

  async function finishTest() {
    if(allowEnd) return;
    if(!confirm("Testni yakunlaysizmi?")) return;
    allowEnd = true;
    audio.pause();
    const res = await fetch("{% url 'listening_submit' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    });
    const data = await res.json();
    window.location.href = data.redirect;
  }
  btnFinish.onclick = finishTest;

  // Audio security
  audio.ontimeupdate = () => { if(!audio.seeking) lastGoodTime = audio.currentTime; };
  audio.onseeking = () => { if(Math.abs(audio.currentTime - lastGoodTime) > 1.5) audio.currentTime = lastGoodTime; };
  audio.onpause = () => { if(!allowEnd && testStarted) audio.play(); };
})();
</script>
{% endblock %}
